<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
      layout:decorate="layout/admin">
<head>
    <title>Budget</title>
    <th:block th:fragment="style" th:remove="tag">
        <!--<link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid.css}">-->
        <link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid-bootstrap4.css}">
        <link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid-bootstrap-ui.css}">
        <style type="text/css">
            input[type='checkbox'], input[type='checkbox']:checked, input[type='checkbox']:not(:checked) {
                display: inline-block;
                position: relative;
                pointer-events: auto;
                opacity: 1;
            }
        </style>
    </th:block>
</head>
<body>
<ul class="collapsible collapsible-accordion" layout:fragment="navbar">
		<div th:include="budget/menu :: navbar" th:remove="tag"></div>
	</ul>
<ul class="breadcrumb" layout:fragment="breadcrumb">
    <li><i class="ace-icon fa fa-home home-icon"></i> <a
            th:href="@{/}">Accueil</a></li>
    <li class="active">Budget</li>
</ul>
<!-- /.breadcrumb -->
<div layout:fragment="content">
    <div class="card card-cascade narrower z-depth-1">
        <!-- Card image -->
        <div class="view view-cascade gradient-card-header blue-gradient narrower py-2 mx-4 mb-3 d-flex justify-content-between align-items-center">

            <div>
                <a id="btnAjoutBudget" data-toggle="modal" data-target="#budgetDlg"
                   class="btn btn-outline-white btn-rounded btn-sm px-2">
                    <i class="fas fa-th-large mt-0"></i> Ajouter
                </a>
                <a id="btnAjoutDetBudget"
                   class="btn btn-outline-white btn-rounded btn-sm px-2">
                    <i class="fas fa-th-large mt-0"></i> Nouveau Detail
                </a>
            </div>

            <a href="" class="white-text mx-3">Budgets Emis </a>

            <div>
                <button id="btnEditBudget" type="button"
                        class="btn btn-outline-white btn-rounded btn-sm px-2">
                    <i class="fas fa-th-list mt-0"></i> Editer
                </button>
            </div>

        </div>
        <!-- /Card image -->

        <div class="px-4">
            <table id="budgetGrid">
            </table>
            <div id="budgetGridPager"></div>
            <br/>
            <table id="detbudgetGrid">
            </table>
            <div id="detbudgetGridPager"></div>
        </div>
    </div>
    <div id="budgetDlg" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header text-center">
                    <h4 class="modal-title w-100 font-weight-bold">Budget</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container-fluid">
                        <form id="frmBudget" action="#" th:action="@{/budget/save}"
                              th:object="${budget}" method="post">
                            <div class="md-form row">
                                <input id="idBudget" name="id" class="form-control"
                                       readonly="readonly">
                                <label>ID</label>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="md-form">
                                        <input type="date" class="form-control"
                                               id="txtDateBudget" th:field="*{dateBudget}">
                                        <label>Date Budget</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <select id="slTypeBudget" class="mdb-select md-form"
                                            th:field="*{typeBudget.id}">
                                        <option value=""></option>
                                        <option th:each="t : ${types}" th:value="${t.id}"
                                                th:text="${t.libelleBudget}"></option>
                                    </select>
                                    <label class="mdb-main-label active">Type Budget</label>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="md-form">
                                        <input type="text" class="form-control"
                                               id="txtCodeBudget" th:field="*{codeBudget}">
                                        <label>Code Budget</label>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="md-form">
                                        <input type="text" class="form-control"
                                               id="txtNomBudget" th:field="*{nomBudget}">
                                        <label>Nom Budget</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <div class="md-form">
                                        <input type="text" class="form-control"
                                               id="txtMontantDem" th:field="*{montantDemande}">
                                        <label>Montant Budget</label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-lg-12">
                                    <select id="statutBudgetSlt" class="mdb-select md-form" th:field="*{statutBudget}">
                                        <option value="ENCOURS">ENCOURS</option>
                                    </select>
                                    <label class="mdb-main-label">Statut</label>
                                </div>
                            </div>
                            <div class="row">
                                <button id="btnValBudget" type="submit" class="btn btn-primary">
                                    <i class="ace-icon fa fa-check"></i> Valider
                                </button>
                                <button id="btnAnnulBudget" type="button" class="btn" onclick="resetFormBudget()">
                                    <i class="ace-icon fa fa-undo"></i> Réinitialiser
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="modalDetBudget" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
         aria-hidden="true">
        <div class="modal-dialog" role="document">
            <form id="frmDetBudget" method="post">
                <div class="modal-content">
                    <div class="modal-header text-center">
                        <h4 class="modal-title w-100 font-weight-bold">Ajout Détail Budget</h4>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body mx-3">
                        <input type="hidden" id="txtIdBudgetDet" class="form-control" name="id">
                        <div class="md-form mb-5">
                            <i class="fas fa-envelope prefix grey-text"></i>
                            <input type="text" id="txtCodeBudgetDet" class="form-control" name="budget.codeBudget"
                                   readonly>
                            <label data-error="wrong" data-success="right" for="txtCodeBudgetDet">Code Budget</label>
                        </div>
                        <div class="md-form mb-4">
                            <i class="fas fa-envelope prefix grey-text"></i>
                            <input type="text" id="txtLibelleBudget" class="form-control"
                                   name="libelleDetailBudget" required>
                            <label data-error="wrong" data-success="right" for="txtLibelleBudget">Libellé Détail
                                Budget</label>
                        </div>

                        <div class="md-form mb-3">
                            <i class="fas fa-lock prefix grey-text"></i>
                            <input type="text" id="txtMontantInitial" class="form-control"
                                   name="montantInitial">
                            <label data-error="wrong" data-success="right" for="txtMontantInitial">Montant
                                Initial</label>
                        </div>

                    </div>
                    <div class="modal-footer d-flex justify-content-center">
                        <button id="btnValDetBudget" class="btn btn-primary">Valider</button>
                        <button id="btnAnnulerDetBudget" type="button" class="btn btn-secondary">Annuler</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<th:block layout:fragment="script" th:remove="tag">
    <script th:src="@{/resources/js/jqgrid/grid.locale-fr.js}"></script>
    <script th:src="@{/resources/js/jqgrid/jquery.jqGrid.min.js}"></script>
    <script th:inline="javascript">
  $.jgrid.defaults.responsive = true;
  $.jgrid.styleUI.Bootstrap4.base.headerTable = "table table-bordered table-condensed";
  $.jgrid.styleUI.Bootstrap4.base.rowTable = "table table-bordered table-striped table-condensed";
  $.jgrid.styleUI.Bootstrap4.base.footerTable = "table table-bordered table-condensed";
  $.jgrid.styleUI.Bootstrap4.base.pagerTable = "table table-condensed";
        var ctx = /*[[@{/}]]*/;
        function resetFormBudget() {
            $("#frmBudget").trigger("reset");
            $("#budgetGrid").jqGrid('resetSelection');
            $('#budgetDlg').modal('hide');
        }

        $(document).ready(function () {

            $('#slTypeBudget').change(function (e) {
                var type = $(this).val();
                if (type) {
                    $.ajax({
                        type: 'GET',
                        url: 'typeBudget/' + type,
                        datatype: 'json'
                    }).done(function (data, status) {
                        $('#txtCodeBudget').val(data.codeTypeBudget);
                        $('#txtCodeBudget').next("label").addClass('active');
                        $('#txtNomBudget').val(data.libelleBudget);
                        $('#txtNomBudget').next("label").addClass('active');
                    }).fail(function (xhr, data, error) {
                        var resp = JSON.parse(xhr.responseText);
                        toastr.error('Erreur d\'execution :' + resp.message);
                    });
                }
            });
        	
            $("#budgetGrid").jqGrid({
                url: 'listBudget',
                mtype: "GET",
                styleUI: 'Bootstrap4',
                iconSet: "fontAwesome",
                datatype: "json",
                colModel: [
                    {label: 'ID', name: 'id', key: true, width: 50},
                    {label: 'Code', name: 'codeBudget', width: 90},
                    {label: 'Libellé', name: 'nomBudget', width: 250},
                    {label: 'Date', name: 'dateBudget', width: 100},
                    {label: 'Montant', name: 'montantDemande', width: 100},
                    {label: 'Statut', name: 'statutBudget', width: 100},
                    {label: 'Valider', name: 'valider', width: 80, formatter: 'checkbox'}
                ],
                page: 1,
                autowidth: true,
                height: 200,
                rowNum: 20,
                rowList: [20, 50, 100],
                sortname: 'id',
                viewrecords: true,
                emptyrecords: 'Pas de Budgets trouvés', // the message will be displayed at the bottom
                pager: "#budgetGridPager",
                onSelectRow: function (rowid, selected) {
                    if (rowid != null) {
                        jQuery("#detbudgetGrid").jqGrid('setGridParam', {
                            url: ctx + "budget/detailBudgets?id=" + rowid,
                            datatype: 'json'
                        }); // the last setting is for demo only
                        jQuery("#detbudgetGrid").jqGrid('setCaption', 'Details Budget N° ' + rowid);
                        jQuery("#detbudgetGrid").trigger("reloadGrid");
                    }
                }, // use the onSelectRow that is triggered on row click to show a details grid
                onSortCol: clearSelection,
                onPaging: clearSelection
            });

            function clearSelection() {
                jQuery("#detbudgetGrid").jqGrid('setGridParam', {
                    url: "/jmcnp/bonNeutre/bnUtilise?idBn=" + $('#bonNeutreId').val(),
                    datatype: 'json'
                }); // the last setting is for demo purpose only
                jQuery("#detbudgetGrid").jqGrid('setCaption', 'Liste des Details');
                jQuery("#detbudgetGrid").trigger("reloadGrid");

            }

            $("#detbudgetGrid").jqGrid({
                mtype: "GET",
                styleUI: 'Bootstrap4',
                iconSet: "fontAwesome",
                datatype: "json",
                colModel: [
                    {label: 'ID', name: 'id', key: true, width: 50},
                    {label: 'Code Budget', name: 'budget.codeBudget', width: 70},
                    {label: 'Libellé', name: 'libelleDetailBudget', width: 180},
                    {label: 'Montant', name: 'montantInitial', width: 120},
                    {label: 'Valider', name: 'valider', width: 80, formatter: 'checkbox'}
                ],
                page: 1,
                autowidth: true,
                height: 250,
                rowNum: 20,
                rowList: [20, 50, 100],
                caption: "Details Budget",
                sortname: 'id',
                viewrecords: true,
                emptyrecords: 'Pas de Details Budgets trouvés', // the message will be displayed at the bottom
                pager: "#detbudgetGridPager"
            });

            $('#frmBudget').submit(function (event) {
                // get the form data
                // there are many ways to get this data using jQuery (you can use the class or id also)
                var formData = $(this).serialize();
                // process the form
                $.ajax({
                    type: 'POST', // define the type of HTTP verb we want to use (POST for our form)
                    url: 'save', // the url where we want to POST
                    data: formData, // our data object
                    dataType: 'json', // what type of data do we expect back from the server
                    encode: true
                }).done(function (data, status) {
                    $('#budgetGrid').jqGrid().trigger('reloadGrid');
                    $('#budgetDlg').modal('hide');
                    toastr.success(data.message);
                }).fail(function (xhr, status, error) {
                    var resp = JSON.parse(xhr.responseText);
                    toastr.error('Erreur d\'execution :' + resp.message);
                });

                // stop the form from submitting the normal way and refreshing the page
                event.preventDefault();
            });

            /*setTimeout(function () {
                var $Input = $('input:-webkit-autofill');
                $Input.next("label").addClass('active');
            }, 200);
            */

            $('#btnAjoutDetBudget').click(function (e) {
                e.preventDefault();
                var grid = $("#budgetGrid");
                var rowKey = grid.jqGrid('getGridParam', "selrow");
                if (rowKey) {
                    var data = grid.jqGrid('getRowData', rowKey);
                    $('#txtCodeBudgetDet').val(data.codeBudget);
                    $('#txtCodeBudgetDet').next("label").addClass('active');
                    $('#modalDetBudget').modal('show');
                } else {
                    toastr.info("Aucune ligne sélectionée");
                }
            });

            $('#frmDetBudget').submit(function (e) {
                var formData = $(this).serialize();
                $.ajax({
                    type: 'POST',
                    url: ctx + '/budget/saveDetail',
                    data: formData,
                    dataType: 'json',
                    encode: true
                }).done(function (data, status) {
                    $('#detbudgetGrid').jqGrid().trigger('reloadGrid');
                    clearDetForm();
                    $('#modalDetBudget').modal('hide');
                    toastr.info(data.message);
                }).fail(function (xhr, status, error) {
                    var resp = JSON.parse(xhr.responseText);
                    toastr.error(resp.description);
                });
                e.preventDefault();
            });

            $('#btnAnnulerDetBudget').click(function (e) {
                clearDetForm();
                $('#modalDetBudget').modal('hide');
            });

            $('#btnEditBudget').click(
                function (e) {
                    e.preventDefault();
                    var grid = $("#budgetGrid");
                    var rowKey = grid.jqGrid('getGridParam', "selrow");
                    if (rowKey) {
                        var data = grid.jqGrid('getRowData', rowKey);
                        location.href = ctx + "/budget/detail/" + data.id;
                    } else {
                        toastr.info("Aucune ligne sélectionée");
                    }
                }
            );

            function clearDetForm() {
                $('#txtCodeBudgetDet').val("");
                $('#txtLibelleBudget').val("");
                $('#txtMontantInitial').val("");
            }
        });

        function getBaseUrl() {
            var url;
            var origin = document.location.origin;
            console.log("Origine : " + origin);
            if (origin.search("localhost") > 0) {
                url = "https://prod.gacsource.net";
            } else if (origin.search("tom") > 0) {
                url = origin.replace("tom", "prod");
            } else {
                url = origin;
            }
            console.log(url);
            return url;
        }

        function myformatter(date) {
            var y = date.getFullYear();
            var m = date.getMonth() + 1;
            var d = date.getDate();
            return (d < 10 ? ('0' + d) : d) + '/' + (m < 10 ? ('0' + m) : m) + '/' + y;
        }

        function isoDate(s) {
            if (!s) return "";
            var ss = (s.split('/'));
            var d = parseInt(ss[0], 10);
            var m = parseInt(ss[1], 10);
            var y = parseInt(ss[2], 10);
            return (y + '-' + (m < 10 ? ('0' + m) : m) + '-' + (d < 10 ? ('0' + d) : d));
        }
    </script>
</th:block>
</body>
</html>