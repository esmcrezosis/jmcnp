<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="layout/admin">

<head>
    <title>Fiche ODD</title>
    <th:block th:fragment="style" th:remove="tag">
        <!--<link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid.css}">-->
        <link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid-bootstrap4.css}">
        <link rel="stylesheet" th:href="@{/resources/plugins/toastr/toastr.min.css}"/>
        <style type="text/css">
            input[type='checkbox'],
            input[type='checkbox']:checked,
            input[type='checkbox']:not(:checked) {
                display: inline-block;
                position: relative;
                pointer-events: auto;
                opacity: 1;
            }
        </style>
    </th:block>
</head>

<body>
<th:block layout:fragment="topbar">
    <div th:include="oksu/menu :: topnav" th:remove="tag"></div>
</th:block>
<!-- /.breadcrumb -->
<div layout:fragment="content" class="mt-1">
    <div class=" card card-default">
        <div class="card-header">
            <div class="card-tools float-right">
                <button class="btn btn-sm btn-default" id="valBci">
                    <i class="fas fa-check"></i>
                     Valider
                </button>
            </div>
            <h2 class="card-title">Obtention Bon de Commande interne</h2>
        </div>
        <div class="container">
            <div class="row mt-2">
                <div class="col-lg-6 ">
                    <div class="md-form input-group mb-3">
                        <input id="codeMembre" type="text" class="form-control" th:value="${codeMembre}" required="required" placeholder="Code Membre" aria-label="Code Membre" aria-describedby="MaterialButton-addon2">
                        <div class="input-group-append">
                            <button class="btn btn-md btn-secondary m-0 px-3" type="button" id="MaterialButton-addon2">QrCode</button>
                        </div>
                        <label class="control-label" for="codeMembre">Code Membre</label>
                    </div>
                </div>
                <div class="col-lg-6">
                    <div class="md-form">
                        <select type="text" id="typeBc" class="mdb-select">
                            <option value="" selected>Choisir la catégorie</option>
                            <option value="r">BC Récurrent</option>
                            <option value="nr">BC Non Récurrent</option>
                        </select>
                        <label class="mdb-main-label" for="typeBc">Type BC</label>
                    </div>
                </div>
            </div>
            <div class="row">
                <div class="md-form col-lg-4" style="margin-top: 11px;">
                    <select type="text" id="typeRecurrent" class="mdb-select">
                        <option value="" selected>Choisir le Type</option>
                        <option value="illimite">Récurrent Illimité</option>
                        <option value="limite">Récurrent Limité</option>
                        <option value="nr">Non Récurrent PRK</option>
                        <option value="nrpre">Non Récurrent PRE</option>
                    </select>
                    <label class="mdb-main-label" for="typeRecurrent">Type Récurrnt</label>
                </div>
                <div class="md-form col-lg-3">
                    <input type="text" id="prkBc" class="form-control">
                    <label for="prkBc">PRK</label>
                </div>
                <div class="md-form col-lg-4">
                    <input type="text" id="montantSm" class="form-control">
                    <label id="lbMontantSm" for="montantSm">Montant</label>
                </div>
                <div class="col-lg-1">
                    <button id="btnSearchCompte" class="btn btn-primary" type="button">
                        <i class="fas fa-search-plus"></i>
                    </button>
                </div>
            </div>
            <table id="tblBci" class="table"></table>
            <div id="pgBci"></div>
        </div>
    </div>
</div>
<th:block layout:fragment="script" th:remove="tag">
    <script th:src="@{/resources/js/jqgrid/grid.locale-fr.js}"></script>
    <script th:src="@{/resources/js/jqgrid/jquery.jqGrid.min.js}"></script>
    <script th:src="@{/resources/plugins/toastr/toastr.min.js}"></script>
    <script type="text/javascript" th:inline="javascript">
        var contextRoot = /*[[@{/}]]*/
        function getParam(code, lib) {
            var result = 0;
            jQuery.ajax({
                url: contextRoot + 'param?code=' + code + '&lib=' + lib,
                success: function (data) {
                    result = data;
                },
                async: false
            });
            return result;
        }

        $(function () {
            var bciTable = $("#tblBci");
            bciTable.jqGrid({
                url: contextRoot + 'cm/bc/',
                mtype: "GET",
                styleUI: 'Bootstrap4',
                iconSet: "fontAwesome",
                postData: {
                    codeMembre: function () {
                        return $("#codeMembre").val();
                    },
                    typeBc: function () {
                        return $("#typeBc").val();
                    },
                    typeRecurrent: function () {
                        return $("#typeRecurrent").val();
                    },
                    prk: function () {
                        return $("#prkBc").val();
                    }
                },
                datatype: "json",
                colModel: [{
                    label: 'ID',
                    name: 'idCredit',
                    key: true,
                    width: 70
                }, {
                    label: 'Date',
                    name: 'dateOctroi',
                    width: 90
                }, {
                    label: 'Type',
                    name: 'euProduit.codeProduit',
                    width: 80
                }, {
                    label: 'MSBC',
                    name: 'montantPlace',
                    width: 130,
                    summaryTpl: "{0}",
                    summaryType: "sum"
                }, {
                    label: 'Montant BC',
                    name: 'montantCredit',
                    width: 120,
                    summaryTpl: "{0}",
                    summaryType: "sum"
                }, {
                    label: 'Debut',
                    name: 'datedeb',
                    width: 90
                }, {
                    label: 'Fin',
                    name: 'datefin',
                    width: 90
                }, {
                    label: 'Type Recurrent',
                    name: 'typeRecurrent',
                    width: 110
                }, {
                    label: 'Duree',
                    name: 'duree',
                    width: 60
                }, {
                    label: 'Nbre Renouv',
                    name: 'nbreRenouvel',
                    width: 80
                }, {
                    label: 'PRK',
                    name: 'prk',
                    width: 60
                }],
                page: 1,
                autowidth: true,
                height: 370,
                rowNum: 20,
                rowList: [20, 50, 100],
                rownumWidth: 25,
                sortname: 'idCredit',
                multiselect: true,
                multiboxonly: true,
                onSelectRow: function (rowId, status, e) {
                    var ids = bciTable.jqGrid('getGridParam', 'selarrrow');
                    var montant = 0;
                    if (status && ids.length > 0) {
                        ids.forEach(row => {
                            var data = bciTable.jqGrid('getRowData', row);
                            if (data['euProduit.codeProduit'] === 'RPGr' || data['euProduit.codeProduit'] === 'Ir') {
                                if (data.typeRecurrent === 'illimite') {
                                    montant += parseFloat(data.montantPlace);
                                } else if (data.typeRecurrent === 'limite') {
                                    var param = getParam("MSBCrl", "PS");
                                    var duree = parseFloat(data.duree);
                                    var reste = duree - parseFloat(data.nbreRenouvel);
                                    var montplace = parseFloat(data.montantPlace);
                                    var bc = montplace/param;
                                    var credit = bc * reste;
                                    montant += Math.floor(credit * param);
                                }
                            } else if (data['euProduit.codeProduit'] === 'RPGnr' || data['euProduit.codeProduit'] === 'Inr') {
                                if (parseFloat(data.montantCredit) > 0) {
                                    montant += Math.floor((parseFloat(data.montantCredit) * 5.6) / parseFloat(data.prk));
                                }
                            }
                        });
                        $('#montantSm').val(montant);
                        $('#lbMontantSm').addClass("active");
                    } else {
                        $('#montantSm').val(0);
                    }
                },
                onSelectAll: function (rowids, status) {
                    var montant = 0;
                    if (status && rowids.length > 0) {
                        rowids.forEach(row => {
                            var data = bciTable.jqGrid('getRowData', row);
                            if (data['euProduit.codeProduit'] === 'RPGr' || data['euProduit.codeProduit'] === 'Ir') {
                                if (data.typeRecurrent === 'illimite') {
                                    montant += parseFloat(data.montantPlace);
                                } else if (data.typeRecurrent === 'limite') {
                                    var param = getParam("MSBCrl", "PS");
                                    var duree = parseFloat(data.duree);
                                    var reste = duree - parseFloat(data.nbreRenouvel);
                                    var montplace = parseFloat(data.montantPlace);
                                    var bc = montplace/param;
                                    var credit = bc * reste;
                                    montant += Math.floor(credit * param);
                                }
                            } else if (data['euProduit.codeProduit'] === 'RPGnr' || data['euProduit.codeProduit'] === 'Inr') {
                                if (parseFloat(data.montantCredit) > 0) {
                                    montant += Math.floor((parseFloat(data.montantCredit) * 5.6) / parseFloat(data.prk));
                                }
                            }
                        });
                        $('#montantSm').val(montant);
                        $('#lbMontantSm').addClass("active");
                    } else {
                        $('#montantSm').val(0);
                    }
                },
                viewrecords: true,
                pager: "#pgBci",
                emptyrecords: 'Pas de lignes trouvees', // the message will be displayed at the bottom

            });

            $("#btnSearchCompte").click(function (e) {
                e.preventDefault();
                bciTable.jqGrid().trigger('reloadGrid');
            });
            $("#valBci").click(function (e) {
                e.preventDefault();
                var sm = {};
                var ids = [];
                var selectedRows =  bciTable.jqGrid('getGridParam', 'selarrrow');
                var i = 0;
                selectedRows.forEach(row => {
                    var cr = {};
                    var data = bciTable.jqGrid('getRowData', row);
                    cr.id = data.idCredit;
                    cr.typeBc = data['euProduit.codeProduit'];
                    cr.msbc= data.montantPlace;
                    cr.bc = data.montantCredit;
                    cr.typeRecurrent = data.typeRecurrent;
                    cr.duree = data.duree;
                    cr.nbreRenouvel = data.nbreRenouvel;
                    cr.prk = data.prk;
                    ids[i] = cr;
                    i++;
                });
                sm.codeMembre = $('#codeMembre').val();
                sm.type = "BC";
                sm.montant = $('#montantSm').val();
                sm.details = ids;
                $.ajax({
                    type: 'POST',
                    url: contextRoot + 'ech/echbc',
                    data: JSON.stringify(sm),
                    dataType: 'json',
                    contentType: 'application/json',
                }).done(function (data, status) {
                    //bciTable.jqGrid().trigger('reloadGrid');
                    toastr.info(data.rep);
                }).fail(function (xhr, status, error) {
                    var resp = JSON.parse(xhr.responseText);
                    toastr.error(resp.message);
                });
            });
        });
    </script>
</th:block>
</body>

</html>