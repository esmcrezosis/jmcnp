<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="layout/admin">
<head>
    <meta charset="UTF-8"/>
    <title>Recouvrement</title>
    <th:block th:fragment="style" th:remove="tag">
        <!--<link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid.css}">-->
        <link rel="stylesheet" th:href="@{/resources/js/jqgrid/ui.jqgrid-bootstrap4.css}">
        <link rel="stylesheet" th:href="@{/resources/plugins/toastr/toastr.min.css}"/>
        <style type="text/css">
            input[type='checkbox'],
            input[type='checkbox']:checked,
            input[type='checkbox']:not(:checked) {
                display: inline-block;
                position: relative;
                pointer-events: auto;
                opacity: 1;
            }
        </style>
    </th:block>
</head>
<body>
<ul class="collapsible collapsible-accordion" layout:fragment="navbar">
    <li><a href="index.html" th:href="@{/home}"> <i
            class="menu-icon fas fa-home"></i> <span class="menu-text">
					Accueil </span>
    </a> <b class="arrow"></b></li>
    <li class=""><a href="#"
                    class="collapsible-header waves-effect arrow-r"> <i
            class="menu-icon fa fa-list"></i> <span class="menu-text">
					Désendettement </span> <b class="arrow fa fa-angle-down"></b>
    </a> <b class="arrow"></b>
        <div class="collapsible-body">
            <ul>
                <li><a href="/mcnp/creance/recouvrement.html"
                       th:href="@{/recouvrer}"> <i class="menu-icon fas fa-circle"></i>
                    <span class="menu-text"> Recouvrement </span>
                </a> <b class="arrow"></b></li>
                <li><a href="/mcnp/creance/recouvrement.html"
                       th:href="@{/payercmfh}"> <i class="menu-icon fas fa-circle"></i>
                    <span class="menu-text"> Recouvrement CMFH </span>
                </a> <b class="arrow"></b></li>
                <li><a href="/mcnp/creance/releve.html"
                       th:href="@{/releve}"> <i
                        class="menu-icon fas fa-credit-card"></i> <span class="menu-text">
								Relevé des Créances </span>
                </a> <b class="arrow"></b></li>
            </ul>
        </div>
    </li>
</ul>
<ul class="breadcrumb" layout:fragment="breadcrumb">
    <li><i class="ace-icon fa fa-home home-icon"></i> <a
            th:href="@{/}">Accueil</a></li>
    <li class="active">Recouvrement</li>
</ul>
<!-- /.breadcrumb -->
<div layout:fragment="content">
    <div class="card">
        <div class="card-body">
            <form id="frm_addRecCmfh" action="#" th:action="@{/recouvrer}"
                  th:object="${recouvrementDto}" method="post">
                <div class="form-header">
                    <h5>Recouvrement CMFH</h5>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="md-form input-group mb-3">
                            <input id="newCodeMembre" type="text" class="form-control"
                                   th:field="*{newCodeMembre}" required="required"
                                   placeholder="Code Membre ESMC" aria-label="Code Membre"
                                   aria-describedby="MaterialButton-addon2">
                            <div class="input-group-append">
                                <button class="btn btn-md btn-secondary m-0 px-3" type="button"
                                        id="btnNewCodeMembre">QrCode
                                </button>
                            </div>
                            <label class="control-label" for="newCodeMembre">Nouveau
                                Code Membre</label>
                        </div>
                    </div>
                    <div class="col-lg-6">
                        <div class="md-form">
                            <input id="mtRecouvrement" type="text" class="form-control" readonly>
                            <label class="active" for="mtRecouvrement">Montant</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-lg-6">
                        <div class="md-form">
                            <input type="text" class="form-control" id="nom_membre" placeholder="Nom"/> <label
                                class="active" for="nom_membre">Nom Membre</label>
                        </div>
                    </div>
                    <div class="col-lg-5">
                        <div class="md-form">
                            <input type="text" class="form-control" id="prenom_membre" placeholder="Prénoms"/> <label
                                class="active" for="prenom_membre">Prénoms Membre</label>
                        </div>
                    </div>
                    <div class="col-lg-1">
                        <button id="searchCMFH" class="btn btn-secondary">
                            <i class="fas fa-search-plus"></i>
                        </button>
                    </div>
                </div>
            </form>
            <table id="tblBci" class="table"></table>
            <div id="pgBci"></div>
        </div>
        <div class="card-footer">
            <div class="form-actions">
                <button id="valRecCmfh" type="submit" class="btn btn-primary">
                    <i class="fas fa-check"></i> Valider
                </button>
                <button class="btn" type="reset">
                    <i class="fas fa-undo"></i> Réinitialiser
                </button>
            </div>
        </div>
    </div>
</div>
<th:block layout:fragment="script" th:remove="tag">
    <script th:src="@{/resources/js/jqgrid/grid.locale-fr.js}"></script>
    <script th:src="@{/resources/js/jqgrid/jquery.jqGrid.min.js}"></script>
    <script th:src="@{/resources/app/qrcode-decoder/qcode-decoder.min.js}"></script>
    <script th:src="@{/resources/app/outil-qr.js}"></script>
    <script type="text/javascript" th:inline="javascript">
        var contextRoot = /*[[@{/}]]*/
        var url = contextRoot + 'cmfh/liste/';
        var bciTable = $("#tblBci");
        $(function () {
            bciTable.jqGrid({
                url: url,
                mtype: "GET",
                styleUI: 'Bootstrap4',
                iconSet: "fontAwesome",
                postData: {
                    codeMembre: function () {
                        return $("#newCodeMembre").val();
                    }
                },
                datatype: "json",
                colModel: [
                    {label: 'ID', name: 'idDepot', key: true, width: 70},
                    {label: 'dateDepot', name: 'dateDepot', width: 90},
                    {label: 'Code Membre', name: 'codeMembre', width: 120},
                    {label: 'MS CMFH', name: 'montDepot', width: 130, summaryTpl: "{0}", summaryType: "sum"},
                    {label: 'Type', name: 'typeDepot', width: 90},
                    {label: 'Payer', name: 'payer', formatter: 'checkbox', width: 90}
                ],
                page: 1,
                autowidth: true,
                height: 270,
                rowNum: 20,
                rowList: [20, 50, 100],
                rownumWidth: 25,
                sortname: 'idDepot',
                multiselect: true,
                multiboxonly: true,
                onSelectRow: function (rowId, status, e) {
                    var ids = bciTable.jqGrid('getGridParam', 'selarrrow');
                    var montant = 0;
                    if (status && ids.length > 0) {
                        ids.forEach(row => {
                            var data = bciTable.jqGrid('getRowData', row);
                            montant += parseFloat(data.montDepot);
                        });
                        $('#mtRecouvrement').val(montant);
                        $('#mtRecouvrement').next("label").addClass('active');
                    } else {
                        $('#mtRecouvrement').val(0);
                        $('#mtRecouvrement').next("label").addClass('active');
                    }
                },
                onSelectAll: function (rowids, status) {
                    var montant = 0;
                    if (status && rowids.length > 0) {
                        rowids.forEach(row => {
                            var data = bciTable.jqGrid('getRowData', row);
                            montant += parseFloat(data.montDepot);
                        });
                        $('#mtRecouvrement').val(montant);
                        $('#mtRecouvrement').next("label").addClass('active');
                    } else {
                        $('#mtRecouvrement').val(0);
                        $('#mtRecouvrement').next("label").addClass('active');
                    }
                },
                viewrecords: true,
                pager: "#pgBci",
                emptyrecords: 'Pas de lignes trouvees', // the message will be displayed at the bottom

            });

            $("#searchCMFH").click(function (e) {
                e.preventDefault();
                bciTable.jqGrid().trigger('reloadGrid');
            });

            $('#newCodeMembre').blur(function (e) {
                e.preventDefault();
                var param = "codeMembre=" + $(this).val();
                $.getJSON(contextRoot +"recherche/membre/", param, function(data) {
                    $("input#nom_membre").val(data.nomMembre);
                    $("input#prenom_membre").val(data.prenomMembre);
                    bciTable.jqGrid().trigger('reloadGrid');
                });
            })

            $('#valRecCmfh').click(function (event) {
                if ($('#newCodeMembre').val() !== ''){
                    var sm = {};
                    var ids = [];
                    var selectedRows = bciTable.jqGrid('getGridParam', 'selarrrow');
                    if (selectedRows.length > 0) {
                        var i = 0;
                        selectedRows.forEach(row => {
                            var data = bciTable.jqGrid('getRowData', row);
                            ids[i] = data.idDepot;
                            i++;
                        });
                        sm.codeMembre = $('#newCodeMembre').val();
                        sm.type = "CMFH";
                        sm.montant = $('#mtRecouvrement').val();
                        sm.ids = ids;
                        $.ajax({
                            type: 'POST',
                            url: contextRoot + 'payercmfh',
                            data: JSON.stringify(sm),
                            dataType: 'json',
                            contentType: 'application/json',
                            encode: true
                        }).done(function (data, status) {
                            bciTable.jqGrid().trigger('reloadGrid');
                            toastr.info(data.message);
                        }).fail(function (xhr, status, error) {
                            var resp = JSON.parse(xhr.responseText);
                            toastr.error(resp.message);
                        });
                    } else {
                        toastr.info("Veuillez sélectionner des lignes");
                    }
                } else {
                    toastr.info("Veuillez fournir le code du membre à rembourser");
                }
                event.preventDefault();
            });
        });
        outilqrbouton_cm("frm_addRecCmfh", "btnNewCodeMembre", "newCodeMembre");

    </script>
</th:block>
</body>
</html>